<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <title th:text="${filename} + ' の画像'">サンプル画像</title>
  <style>
    img {
      max-width: 90%;
      height: auto;
    }

    .comment {
      border-top: 1px solid #ddd;
      padding: 8px 0;
    }

    .meta {
      color: #666;
      font-size: 0.9em;
    }
  </style>

  <script th:inline="javascript">
    /*<![CDATA[*/
    const filename = /*[[${filename}]]*/ 'sample.png';
    const csrfToken = /*[[${_csrf.token}]]*/ '';
    const csrfParam = /*[[${_csrf.parameterName}]]*/ '_csrf';

    window.addEventListener('load', function () {

      // 1秒ごとに更新チェック
      setInterval(function () {
        // 1. 画像の生存確認
        fetch('/sampleimage/exists?filename=' + encodeURIComponent(filename))
          .then(res => res.json())
          .then(exists => {
            if (!exists) {
              alert('この画像は削除されました。カレンダーに戻ります。');
              window.location.href = '/calendar';
            }
          })
          .catch(err => console.error('Image check error:', err));

        // 2. コメントの更新 (APIを呼び出す)
        fetch('/sampleimage/api/comments?filename=' + encodeURIComponent(filename))
          .then(res => res.json())
          .then(data => renderComments(data))
          .catch(err => console.error('Comments fetch error:', err));

      }, 1000);
    });

    // 日時フォーマット (2026-01-09T14:00:00 -> 2026-01-09 14:00)
    function formatDateTime(isoString) {
      if (!isoString) return "";
      const date = new Date(isoString);
      const y = date.getFullYear();
      const m = ('0' + (date.getMonth() + 1)).slice(-2);
      const d = ('0' + date.getDate()).slice(-2);
      const H = ('0' + date.getHours()).slice(-2);
      const M = ('0' + date.getMinutes()).slice(-2);
      return y + '-' + m + '-' + d + ' ' + H + ':' + M;
    }

    // コメントリストの描画
    function renderComments(comments) {
      const container = document.getElementById('comments-container');
      if (!container) return;

      container.innerHTML = ''; // 一度クリア

      // ヘッダーの件数を更新
      const countHeader = document.getElementById('comment-count');
      if (countHeader) countHeader.innerText = comments.length;

      // コメントを1つずつ作成して追加
      comments.forEach(c => {
        const div = document.createElement('div');
        div.className = 'comment';

        // メタ情報 (投稿者, 日時, 削除ボタン)
        const metaDiv = document.createElement('div');
        metaDiv.className = 'meta';

        // 投稿者
        const authorSpan = document.createElement('span');
        authorSpan.innerText = c.author;
        metaDiv.appendChild(authorSpan);

        metaDiv.appendChild(document.createTextNode(' — '));

        // 日時
        const dateSpan = document.createElement('span');
        dateSpan.innerText = formatDateTime(c.createdAt);
        metaDiv.appendChild(dateSpan);

        // 削除ボタン (権限がある場合のみ、元のデザインで作成)
        if (c.canDelete) {
          const btnDiv = document.createElement('div');
          btnDiv.style.marginTop = '6px'; // style="margin-top:6px;"

          const form = document.createElement('form');
          form.method = 'post';
          form.action = '/sampleimage/comment/delete';
          form.style.display = 'inline'; // style="display:inline;"

          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = csrfParam;
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);

          const idInput = document.createElement('input');
          idInput.type = 'hidden';
          idInput.name = 'id';
          idInput.value = c.id;
          form.appendChild(idInput);

          const btn = document.createElement('button');
          btn.type = 'submit';
          btn.innerText = '削除';

          // ★元のHTMLのスタイルを適用
          btn.style.background = '#d9534f';
          btn.style.color = 'white';
          btn.style.border = 'none';
          btn.style.padding = '6px 10px';
          btn.style.borderRadius = '3px';

          form.appendChild(btn);
          btnDiv.appendChild(form);

          // div.comment に追加
          div.appendChild(metaDiv); // 先にmeta

          const textDiv = document.createElement('div');
          textDiv.innerText = c.text;
          div.appendChild(textDiv);

          div.appendChild(btnDiv); // 最後に削除ボタンdiv
        } else {
          // 削除ボタンがない場合
          div.appendChild(metaDiv);
          const textDiv = document.createElement('div');
          textDiv.innerText = c.text;
          div.appendChild(textDiv);
        }

        container.appendChild(div);
      });
    }
    /*]]>*/
  </script>
</head>

<body>
  <h1 th:text="${filename} + ' のリアクションとコメント'">サンプル画像</h1>

  <div>
    <img th:src="@{/uploads/{name}(name=${filename})}" alt="image" />
  </div>

  <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
    <form th:action="@{/sampleimage/react}" method="post" style="display:inline;">
      <input type="hidden" name="filename" th:value="${filename}" />
      <input type="hidden" name="type" value="heart" />
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <button type="submit" style="font-size:1.2em; background:none; border:none; cursor:pointer;">
        <span style="color:#e25555;">&#10084;</span>
        <span th:if="${hasReacted}" th:text="${heartCount}">0</span>
      </button>
    </form>

    <form th:action="@{/sampleimage/react}" method="post" style="display:inline;">
      <input type="hidden" name="filename" th:value="${filename}" />
      <input type="hidden" name="type" value="like" />
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <button type="submit" style="font-size:1.2em; background:none; border:none; cursor:pointer;">
        <span style="color:#0077cc;">&#128077;</span>
        <span th:if="${hasReacted}" th:text="${likeCount}">0</span>
      </button>
    </form>

    <form th:action="@{/sampleimage/react}" method="post" style="display:inline;">
      <input type="hidden" name="filename" th:value="${filename}" />
      <input type="hidden" name="type" value="laugh" />
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <button type="submit" style="font-size:1.2em; background:none; border:none; cursor:pointer;">
        <span style="color:#f1c40f;">&#128518;</span>
        <span th:if="${hasReacted}" th:text="${laughCount}">0</span>
      </button>
    </form>
  </div>

  <div th:if="${error}" style="color:#b00;margin-top:8px;" th:text="${error}"></div>

  <div style="margin-top:16px;">
    <form th:action="@{/sampleimage/comment}" method="post">
      <input type="hidden" name="filename" th:value="${filename}" />
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <div>
        <label>コメント:<br />
          <textarea name="text" rows="4" cols="60" required></textarea>
        </label>
      </div>
      <div>
        <button type="submit">投稿</button>
      </div>
    </form>
  </div>

  <div style="margin-top:24px;">
    <h2>コメント (<span id="comment-count" th:text="${#lists.size(comments)}">0</span>)</h2>

    <div id="comments-container">

      <div th:each="c : ${comments}" class="comment">
        <div class="meta">
          <span th:text="${c.author}">投稿者</span> — <span
            th:text="${#temporals.format(c.createdAt,'yyyy-MM-dd HH:mm')}">日時</span>
        </div>
        <div th:text="${c.text}">コメント本文</div>

        <div th:if="${c.author == #authentication.name or isAdmin}" style="margin-top:6px;">
          <form th:action="@{/sampleimage/comment/delete}" method="post" style="display:inline;">
            <input type="hidden" name="id" th:value="${c.id}" />
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit"
              style="background:#d9534f; color:white; border:none; padding:6px 10px; border-radius:3px;">
              削除
            </button>
          </form>
        </div>

      </div>

    </div>
  </div>

  <div th:if="${isOwner}"
    style="margin-top: 40px; border-top: 1px solid #ccc; padding-top: 20px; background-color: #fff0f0; padding: 10px;">
    <h3 style="margin-top: 0; color: #d9534f;">管理メニュー</h3>
    <p>この画像を削除すると、関連するコメントやリアクションも全て消えます。</p>
    <form th:action="@{/sampleimage/delete}" method="post" onsubmit="return confirm('本当にこの画像を削除しますか？\n（復元できません）');">
      <input type="hidden" name="filename" th:value="${filename}" />
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <button type="submit"
        style="background-color: #d9534f; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: bold;">
        この画像を削除する
      </button>
    </form>
  </div>

  <p><a th:href="@{/calendar}">カレンダーに戻る</a></p>
</body>

</html>
