<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <title>申請一覧</title>
  <style>
    /* 画面全体で中央揃え（横・縦中央） */
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
      background: #f7f8fa;
      color: #222;
    }

    .page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      /* 垂直中央 */
      justify-content: center;
      /* 水平中央 */
      padding: 24px;
      box-sizing: border-box;
    }

    .card {
      width: 100%;
      max-width: 1000px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(20, 20, 40, 0.08);
      padding: 24px;
      box-sizing: border-box;
      text-align: center;
    }

    h1 {
      margin: 0 0 16px 0;
      font-size: 1.6rem;
    }

    .messages {
      margin-bottom: 12px;
      font-weight: 600;
    }

    .messages .error {
      color: #b00;
    }

    .messages .message {
      color: green;
    }

    table.pending {
      width: 100%;
      border-collapse: collapse;
      margin: 16px auto 0 auto;
      /* 中央 */
    }

    table.pending th,
    table.pending td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: left;
      vertical-align: middle;
      font-size: 0.95rem;
    }

    table.pending thead th {
      background: #f5f7fa;
      text-align: center;
    }

    td.actions {
      text-align: center;
      white-space: nowrap;
    }

    form.inline {
      display: inline-block;
      margin: 0 4px;
    }

    button {
      background: #0078d4;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
    }

    button.reject {
      background: #d9534f;
    }

    a.top-link {
      display: inline-block;
      margin-top: 14px;
      color: #0078d4;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
  <div class="page">
    <div class="card">
      <h1>ユーザ登録申請一覧</h1>
      <div id="messages">
        <div th:if="${param.error}" class="error" th:text="${param.error}"></div>
        <div th:if="${param.message}" class="message" th:text="${param.message}"></div>
      </div>

      <table class="pending" cellpadding="5">
        <thead>
          <tr>
            <th style="width:8%;">ID</th>
            <th style="width:40%;">ユーザ名</th>
            <th style="width:30%;">申請日時</th>
            <th style="width:22%;">操作</th>
          </tr>
        </thead>
        <tbody id="pending-tbody">
          <!-- 初期はサーバ描画でも良いが JS が定期的に更新する -->
          <tr th:each="p : ${pendings}">
            <td th:text="${p.id}">1</td>
            <td th:text="${p.username}">user</td>
            <td th:text="${#temporals.format(p.createdAt,'yyyy-MM-dd HH:mm')}">日時</td>
            <td>
              <form th:action="@{/admin/pending/approve/{id}(id=${p.id})}" method="post" style="display:inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit">承認</button>
              </form>
              <form th:action="@{/admin/pending/reject/{id}(id=${p.id})}" method="post" style="display:inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit">却下</button>
              </form>
            </td>
          </tr>
        </tbody>
      </table>

      <p><a th:href="@{/}" class="top-link">トップへ</a></p>
    </div>
  </div>

  <script>
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    // pending 一覧を取得して tbody を書き換える
    async function refreshPending() {
      try {
        const res = await fetch('/admin/pending/api', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('failed to fetch pending list');
        const list = await res.json();
        const tbody = document.getElementById('pending-tbody');
        tbody.innerHTML = '';
        if (!Array.isArray(list) || list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px 0;">申請はありません。</td></tr>';
          return;
        }
        list.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.username}</td>
            <td>${formatCreatedAt(p.createdAt)}</td>
            <td>
              <button data-id="${p.id}" class="approve">承認</button>
              <button data-id="${p.id}" class="reject">却下</button>
            </td>`;
          tbody.appendChild(tr);
        });
        // イベント付与
        document.querySelectorAll('.approve').forEach(btn => {
          btn.onclick = async (e) => {
            const id = e.target.getAttribute('data-id');
            await postAction('/admin/pending/approve/' + id);
            await refreshPending();
          };
        });
        document.querySelectorAll('.reject').forEach(btn => {
          btn.onclick = async (e) => {
            const id = e.target.getAttribute('data-id');
            await postAction('/admin/pending/reject/' + id);
            await refreshPending();
          };
        });
      } catch (err) {
        console.error(err);
      }
    }

    function formatCreatedAt(s) {
      if (!s) return '';
      // サーバから ISO 文字列が来る前提。簡易整形:
      return s.replace('T', ' ').substring(0, 16);
    }

    async function postAction(url) {
      const res = await fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { [csrfHeader]: csrfToken }
      });
      if (!res.ok) {
        console.error('action failed', res.status);
      }
    }

    // 初回取得 + 5秒毎に更新
    refreshPending();
    setInterval(refreshPending, 5000);
  </script>
</body>

</html>
