<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>イベントカレンダー</title>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }

    .calendar-container {
      display: inline-block;
      margin-top: 20px;
    }

    table {
      border-collapse: collapse;
      width: 400px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 10px;
      width: 14%;
      height: 60px;
      vertical-align: top;
    }

    th.sun {
      color: red;
      background-color: #ffeeee;
    }

    th.sat {
      color: blue;
      background-color: #eeeeff;
    }

    th {
      background-color: #f0f0f0;
    }

    td.highlight {
      position: relative;
      z-index: 0;
    }

    /* 外側にグラデーション枠を描く */
    td.highlight::before {
      content: "";
      position: absolute;
      inset: -4px;
      /* 枠の太さ */
      z-index: -1;
      border-radius: 4px;
      background: linear-gradient(135deg,
          #ff5252,
          #ffb347,
          #42a5f5,
          #ab47bc,
          #ff5252);
      background-size: 300% 300%;
      animation: borderFlow 4s linear infinite;
    }

    /* 内側のセル背景を白に戻す (はみ出し防止) */
    td.highlight::after {
      content: "";
      position: absolute;
      inset: 0;
      background: #ffffff;
      z-index: -1;
    }

    /* 枠のグラデーションがゆっくり流れるアニメーション */
    @keyframes borderFlow {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* 枠の光がゆっくり強弱するアニメーション */
    @keyframes highlightPulse {
      from {
        box-shadow:
          inset 0 0 0 2px #ff6347,
          0 0 4px rgba(255, 99, 71, 0.4);
      }

      to {
        box-shadow:
          inset 0 0 0 2px #ff6347,
          0 0 16px rgba(255, 99, 71, 1);
      }
    }


    .day-link {
      text-decoration: none;
      display: block;
      font-weight: bold;
      color: black;
    }

    .day-link:hover {
      background-color: #f0f8ff;
    }

    .nav-link {
      text-decoration: none;
      font-size: 18px;
      padding: 5px 15px;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
    }

    .nav-link:hover {
      background-color: #0056b3;
    }

    .current-month {
      font-size: 24px;
      margin: 0 20px;
      font-weight: bold;
    }

    .upload-section {
      margin-top: 40px;
      padding: 20px;
      border-top: 2px solid #ddd;
    }

    td.today {
      background-color: #D3D3D3;
    }

    td.highlight.today::after {
      background: #98FB98;
    }

    #active-users-wrapper {
      position: absolute;
      top: 50px;
      /* 赤い部分の位置を指定 */
      right: 5px;
      /* 赤い部分の右方向の位置 */
      width: 225px;
      height: 150px;
      background-color: #ffeeee;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }

    #active-users-section {
      font-size: 16px;
      text-align: left;
    }

    #active-users-list li {
      list-style: none;
      margin-top: 8px;
    }
  </style>
</head>

<body>

  <div class="calendar-container">
    <h2>カレンダー</h2>

    <div style="margin-bottom: 15px;">
      <a class="nav-link" th:href="@{/calendar(year=${prevYear}, month=${prevMonth})}">&lt; 前月</a>

      <span class="current-month">[[${targetYear}]]年 [[${targetMonth}]]月</span>

      <a class="nav-link" th:href="@{/calendar(year=${nextYear}, month=${nextMonth})}">次月 &gt;</a>
    </div>

    <table>
      <thead>
        <tr>
          <th class="sun">日</th>
          <th>月</th>
          <th>火</th>
          <th>水</th>
          <th>木</th>
          <th>金</th>
          <th class="sat">土</th>
        </tr>
      </thead>

      <tbody>
        <tr th:each="week : ${calendarMatrix}">
          <td th:each="day : ${week}" th:classappend="
              (${day != null and highlightDays != null and highlightDays.contains(day)} ? ' highlight' : '') +
              (${day != null and todayDay != null and day == todayDay} ? ' today' : '')
              ">
            <div th:if="${day != null}">
              <a class="day-link" th:href="@{/schedule/day(date=${targetYear} + '-' + ${targetMonth} + '-' + ${day})}">
                [[${day}]]
              </a>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <p><a href="/">トップへ戻る</a></p>
    <a href="/logout">ログアウト</a>
  </div>


  <!-- ★★★ 画像アップロードフォーム ★★★ -->
  <div class="upload-section">
    <h2>画像をアップロードのみ</h2>

    <div th:if="${error}"
      style="color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; padding: 10px; margin-bottom: 15px; border: 1px solid transparent; border-radius: 4px;">
      <strong>エラー:</strong> <span th:text="${error}">エラーメッセージ</span>
    </div>

    <form th:action="@{/upload}" th:method="post" enctype="multipart/form-data">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <div>
        <label>画像ファイル:</label>
        <input type="file" name="imageFile" accept="image/*" required>
      </div>

      <div>
        <label>指定日時:</label>
        <input type="datetime-local" name="scheduledTime" required>
      </div>

      <br>
      <button type="submit">アップロード</button>
    </form>

    <div th:if="${param.error}" style="color: red;">
      失敗しました。
    </div>
    <div th:if="${param.success}" style="color: green;">
      保存しました！
    </div>
  </div>

  <!-- 現在ログイン中のユーザ表示 -->
  <div id="active-users-wrapper">
    <section id="active-users-section">
      <h3>現在ログイン中のユーザ</h3>
      <ul id="active-users-list">
        <li>読み込み中...</li>
      </ul>
    </section>
  </div>

  <script>
    const fetchActiveUsers = () => {
      fetch('/active-users', { credentials: 'same-origin' })
        .then(res => {
          if (!res.ok) throw new Error('failed to fetch active users');
          return res.json();
        })
        .then(list => {
          const ul = document.getElementById('active-users-list');
          ul.innerHTML = '';
          if (!Array.isArray(list) || list.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'ログイン中のユーザはいません';
            ul.appendChild(li);
            return;
          }
          list.forEach(u => {
            const li = document.createElement('li');
            li.textContent = u;
            ul.appendChild(li);
          });
        })
        .catch(err => {
          console.error(err);
        });
    };

    // 初回取得 + 5秒ごとに更新（必要に応じて間隔を変えてください）
    fetchActiveUsers();
    setInterval(fetchActiveUsers, 5000);
  </script>


</body>

</html>
