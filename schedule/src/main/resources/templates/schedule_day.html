<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title th:text="${date} + ' の予定'">1日の予定</title>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    .hour-row {
      border-bottom: 1px solid #ccc;
      padding: 8px 10px;
      min-height: 30px;
    }

    .time-label {
      font-weight: bold;
      color: #444;
      margin-right: 10px;
    }

    .plan-box {
      display: inline-block;
      margin-left: 20px;
      background-color: #1e90ff;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 14px;
    }

    .debug-box {
      background-color: #f0f0f0;
      border: 2px dashed #888;
      padding: 10px;
      margin-bottom: 20px;
      color: #333;
    }
  </style>
</head>

<body>

  <h2 th:text="${date} + ' の予定'"></h2>

  <!-- 時間ごとのブロック -->
  <div th:each="h : ${hours}" class="hour-row">

    <!-- 時刻 -->
    <span class="time-label" th:text="${h} + '時'"></span>

    <div th:if="${plansByHour[h] != null}">
      <span th:text="${plansByHour[h].title}" class="title"></span>
    </div>

    <div th:if="${imagesByHour.containsKey(h)}" style="margin-left:20px;">

      <div th:each="imgName : ${imagesByHour.get(h)}">

        <a th:href="@{/sampleimage(filename=${imgName})}" th:text="${imgName}">ファイル名</a>
        <br />

        <!-- サムネは表示自体は /uploads のまま。クリックしたら詳細へ -->
        <a th:href="@{/sampleimage(filename=${imgName})}">
          <img th:src="@{/uploads/{name}(name=${imgName})}"
            style="max-width:150px; max-height:150px; margin-top:5px; border:1px solid #ddd;" />
        </a>
        <hr />
      </div>
    </div>

    <!-- ★ 全予定(plans)を回して、startTime.hour==h のものだけ表示 -->
    <span th:each="p : ${plans}" th:if="${p.startTime.hour == h}" class="plan-box">

      <span style="font-weight:bold; color:#ffeb3b; margin-right:5px;" th:text="'[' + ${p.userName} + ']'"></span>

      <span th:text="${p.title}"></span>
      （<span th:text="${p.startTime}"></span>
      〜
      <span th:text="${p.endTime}"></span>）

      <form th:action="@{/schedule/delete}" method="post" style="display:inline-block; margin-left:5px;"
        th:if="${p.userName == #authentication.name}" onsubmit="return confirm('削除しますか？');">
        <input type="hidden" name="id" th:value="${p.id}" />
        <input type="hidden" name="date" th:value="${date}" />
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit"
          style="font-size:0.8em; cursor:pointer; background:#d9534f; color:white; border:none; border-radius:3px;">×</button>
      </form>
    </span>

  </div>

  <!-- 予定追加フォーム -->
  <h3>予定を追加する</h3>

  <form action="/addplan" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    <input type="hidden" name="year" th:value="${#strings.substring(date,0,4)}" />
    <input type="hidden" name="month" th:value="${#strings.substring(date,5,7)}" />
    <input type="hidden" name="day" th:value="${#strings.substring(date,8,10)}" />

    <label>開始時間:
      <input type="time" name="start_time" required />
    </label><br>

    <label>終了時間:
      <input type="time" name="end_time" required />
    </label><br>

    <label>タイトル:
      <input type="text" name="title" required />
    </label><br><br>

    <button type="submit">追加</button>
  </form>

  <p><a href="/calendar">カレンダーに戻る</a></p>

</body>

</html>
