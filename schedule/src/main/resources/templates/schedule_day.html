<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title th:text="${date} + ' の予定'">1日の予定</title>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    .hour-row {
      border-bottom: 1px solid #ccc;
      padding: 8px 10px;
      min-height: 30px;
    }

    .time-label {
      font-weight: bold;
      color: #444;
      margin-right: 10px;
      vertical-align: top;
    }

    .plans-container {
      display: inline-block;
      vertical-align: top;
      width: 80%;
    }

    .plan-box {
      display: inline-block;
      margin-left: 10px;
      margin-bottom: 5px;
      background-color: #1e90ff;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 14px;
    }

    .delete-btn {
      font-size: 0.8em;
      cursor: pointer;
      background: #d9534f;
      color: white;
      border: none;
      border-radius: 3px;
      margin-left: 5px;
      padding: 0 5px;
    }
  </style>

  <script th:inline="javascript">
    /*<![CDATA[*/
    const currentDate = /*[[${date}]]*/ '2025-01-01';
    const currentUserName = /*[[${#authentication.name}]]*/ 'user';
    const csrfToken = /*[[${_csrf.token}]]*/ '';
    const csrfParam = /*[[${_csrf.parameterName}]]*/ '_csrf';

    // 【追加】前回のデータを保存しておく変数
    let lastSchedulesJson = "";
    let lastImagesJson = "";

    window.addEventListener('load', function () {
      // 1秒ごとに更新
      setInterval(fetchAllData, 1000);
      fetchAllData();
    });

    function fetchAllData() {
      // 予定の更新
      fetch('/schedule/api/list?date=' + currentDate)
        .then(res => res.json())
        .then(data => {
          // 【追加】データの中身が変わったときだけ描画関数を呼ぶ
          const currentJson = JSON.stringify(data);
          if (currentJson !== lastSchedulesJson) {
            lastSchedulesJson = currentJson;
            renderSchedules(data);
          }
        })
        .catch(err => console.error(err));

      // 画像の更新
      fetch('/images/api/list?date=' + currentDate)
        .then(res => res.json())
        .then(data => {
          // 【追加】データの中身が変わったときだけ描画関数を呼ぶ
          const currentJson = JSON.stringify(data);
          if (currentJson !== lastImagesJson) {
            lastImagesJson = currentJson;
            renderImages(data);
          }
        })
        .catch(err => console.error(err));
    }

    // --- 予定の描画処理 ---
    function formatTime(timeData) {
      if (typeof timeData === 'string') {
        return timeData.substring(0, 5);
      }
      return "00:00";
    }

    function renderSchedules(schedules) {
      // 1. 全エリアクリア
      for (let h = 0; h < 24; h++) {
        const container = document.getElementById('plans-container-' + h);
        if (container) container.innerHTML = '';
      }
      // 2. 配置
      schedules.forEach(plan => {
        const hour = plan.hour;
        const container = document.getElementById('plans-container-' + hour);

        if (container) {
          const planBox = document.createElement('span');
          planBox.className = 'plan-box';

          const userSpan = document.createElement('span');
          userSpan.style.fontWeight = 'bold';
          userSpan.style.color = '#ffeb3b';
          userSpan.style.marginRight = '5px';
          userSpan.innerText = '[' + (plan.userName ? plan.userName : '匿名') + ']';
          planBox.appendChild(userSpan);

          const timeStr = formatTime(plan.startTime) + ' 〜 ' + formatTime(plan.endTime);
          const textNode = document.createTextNode(plan.title + ' (' + timeStr + ')');
          planBox.appendChild(textNode);

          if (plan.userName === currentUserName) {
            const form = document.createElement('form');
            form.method = 'post';
            form.action = '/schedule/delete';
            form.style.display = 'inline-block';
            form.onsubmit = function () { return confirm('削除しますか？'); };

            const createInput = (name, value) => {
              const i = document.createElement('input');
              i.type = 'hidden'; i.name = name; i.value = value;
              return i;
            };
            form.appendChild(createInput(csrfParam, csrfToken));
            form.appendChild(createInput('id', plan.id));
            form.appendChild(createInput('date', currentDate));

            const btn = document.createElement('button');
            btn.type = 'submit';
            btn.className = 'delete-btn';
            btn.innerText = '×';
            form.appendChild(btn);
            planBox.appendChild(form);
          }
          container.appendChild(planBox);
        }
      });
    }

    // --- 画像の描画処理 ---
    function renderImages(images) {
      // 1. 全エリアクリア
      for (let h = 0; h < 24; h++) {
        const container = document.getElementById('images-container-' + h);
        if (container) container.innerHTML = '';
      }

      // 2. 画像を配置
      images.forEach(img => {
        const hour = img.hour;
        const container = document.getElementById('images-container-' + hour);

        if (container) {
          const div = document.createElement('div');

          // 1. ファイル名リンク
          const linkName = document.createElement('a');
          linkName.href = '/sampleimage?filename=' + encodeURIComponent(img.filename);
          linkName.innerText = img.filename;
          div.appendChild(linkName);

          div.appendChild(document.createElement('br'));

          // 2. 画像リンク(サムネ)
          const linkImg = document.createElement('a');
          linkImg.href = '/sampleimage?filename=' + encodeURIComponent(img.filename);

          const imageTag = document.createElement('img');
          imageTag.src = '/uploads/' + img.filename;
          imageTag.style.maxWidth = '150px';
          imageTag.style.maxHeight = '150px';
          imageTag.style.marginTop = '5px';
          imageTag.style.border = '1px solid #ddd';

          linkImg.appendChild(imageTag);
          div.appendChild(linkImg);

          div.appendChild(document.createElement('hr'));

          container.appendChild(div);
        }
      });
    }

    function validateForm() {
      const start = document.getElementById('start_time').value;
      const end = document.getElementById('end_time').value;
      if (start && end) {
        if (end <= start) {
          alert("終了時刻は開始時刻より後に設定してください。");
          return false;
        }
      }
      return true;
    }
    /*]]>*/
  </script>
</head>

<body>

  <h2 th:text="${date} + ' の予定'"></h2>

  <div th:if="${error}"
    style="color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; padding: 10px; margin-bottom: 15px; border: 1px solid transparent; border-radius: 4px;">
    <strong>エラー:</strong> <span th:text="${error}">エラーメッセージ</span>
  </div>

  <div th:each="h : ${hours}" class="hour-row">
    <span class="time-label" th:text="${h} + '時'"></span>

    <div style="margin-left: 20px;" th:id="'images-container-' + ${h}"></div>

    <div class="plans-container" th:id="'plans-container-' + ${h}"></div>
  </div>

  <hr>

  <h3>予定を追加する</h3>
  <form action="/addplan" method="post" onsubmit="return validateForm()">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" name="year" th:value="${#strings.substring(date,0,4)}" />
    <input type="hidden" name="month" th:value="${#strings.substring(date,5,7)}" />
    <input type="hidden" name="day" th:value="${#strings.substring(date,8,10)}" />

    <label>開始時間: <input type="time" name="start_time" id="start_time" required /></label><br>
    <label>終了時間: <input type="time" name="end_time" id="end_time" required /></label><br>
    <label>タイトル: <input type="text" name="title" required /></label><br><br>
    <button type="submit">追加</button>
  </form>

  <p><a href="/calendar">カレンダーに戻る</a></p>

</body>

</html>
